name: crypto_det

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  ingestor-service:
    build: ./services/ingestor-service
    environment:
      - REDIS_URL=${REDIS_URL}
      - INGEST_POLL_SECONDS=${INGEST_POLL_SECONDS}
      - COINRANKING_API_KEY=${COINRANKING_API_KEY}
    depends_on:
      - redis

  detector-service:
    build: ./services/detector-service
    environment:
      - REDIS_URL=${REDIS_URL}
      - DETECT_CHANGE_THRESHOLD=${DETECT_CHANGE_THRESHOLD}
      - ALERT_DEDUP_SECONDS=${ALERT_DEDUP_SECONDS}
    depends_on:
      - redis
      - ingestor-service

  api-service:
    build: ./services/api-service
    environment:
      - REDIS_URL=${REDIS_URL}
      - SERVICE_NAME=${SERVICE_NAME}
      - SERVICE_VERSION=${SERVICE_VERSION}
      - BUILD_TIME=${BUILD_TIME}
      - GIT_COMMIT=${GIT_COMMIT}
    ports:
      - "8000:8000"
    depends_on:
      - redis

  web-frontend:
    build: ./web-frontend
    ports:
      - "8080:80"
    depends_on:
      - api-service

  # ---------------- Observability ----------------
  prometheus:
    image: prom/prometheus:v2.51.2
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    depends_on:
      - api-service

  loki:
    image: grafana/loki:2.9.8
    command: -config.file=/etc/loki/loki-config.yml
    volumes:
      - ./observability/loki/loki-config.yml:/etc/loki/loki-config.yml:ro
    ports:
      - "3100:3100"

  grafana:
    image: grafana/grafana:10.4.2
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./observability/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./observability/grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - loki

  # Optional log shipping (Linux host path; Docker Desktop may differ)
  promtail:
    image: grafana/promtail:2.9.8
    profiles: ["logging"]
    command: -config.file=/etc/promtail/promtail-config.yml
    volumes:
      - ./observability/promtail/promtail-config.yml:/etc/promtail/promtail-config.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/log:/var/log:ro
    depends_on:
      - loki

  # ---------------- Load testing ----------------
  locust:
    image: locustio/locust:2.27.0
    profiles: ["loadtest"]
    volumes:
      - ./loadtest:/mnt/locust:ro
    command: -f /mnt/locust/locustfile.py --host http://web-frontend
    ports:
      - "8089:8089"
    depends_on:
      - web-frontend
